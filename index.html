<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3B82F6">
    <title>Asistente de Compras IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .chat-scroll { scroll-behavior: smooth; }
    </style>
</head>
<body class="m-0 p-0 bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="app"></div>

    <script>
        class ShoppingAssistant {
            constructor() {
                this.items = [];
                this.history = [];
                this.conversation = [];
                this.pendingItems = null;
                this.loading = false;
                this.isListening = false;
                this.voiceSupported = false;
                this.recognition = null;
                this.showList = true;
                
                this.init();
            }

            init() {
                this.loadData();
                this.setupVoiceRecognition();
                this.render();
            }

            loadData() {
                try {
                    const saved = localStorage.getItem('shopping-items');
                    if (saved) this.items = JSON.parse(saved);
                    
                    const savedHistory = localStorage.getItem('purchase-history');
                    if (savedHistory) this.history = JSON.parse(savedHistory);
                    
                    const savedConversation = localStorage.getItem('conversation');
                    if (savedConversation) this.conversation = JSON.parse(savedConversation);
                } catch (e) {
                    console.log('No hay datos guardados');
                }
            }

            setupVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    this.voiceSupported = true;
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.lang = 'es-AR';
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        this.isListening = false;
                        this.updateUI();
                    };

                    this.recognition.onerror = () => {
                        this.isListening = false;
                        this.updateUI();
                    };

                    this.recognition.onend = () => {
                        this.isListening = false;
                        this.updateUI();
                    };
                }
            }

            startVoice() {
                if (this.recognition && !this.isListening) {
                    this.isListening = true;
                    this.recognition.start();
                    this.updateUI();
                }
            }

            stopVoice() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    this.isListening = false;
                    this.updateUI();
                }
            }

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Agregar mensaje del usuario
                this.conversation.push({
                    role: 'user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                input.value = '';
                this.loading = true;
                this.updateUI();
                this.scrollToBottom();

                try {
                    const response = await fetch('/.netlify/functions/claude-api', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input: message,
                            conversation: this.conversation.slice(-6), // √öltimos 6 mensajes para contexto
                            currentItems: this.items
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0]?.text) {
                        let text = data.content[0].text.trim();
                        
                        // Intentar parsear como JSON para productos
                        try {
                            text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                            const parsed = JSON.parse(text);
                            
                            if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].name) {
                                // Son productos
                                this.pendingItems = parsed.map((item, i) => ({
                                    id: Date.now() + i,
                                    name: item.name || 'Sin nombre',
                                    quantity: item.quantity || '1 unidad',
                                    category: item.category || 'Otros',
                                    estimatedPrice: parseFloat(item.estimatedPrice || 0),
                                    purchased: false
                                }));
                                
                                this.conversation.push({
                                    role: 'assistant',
                                    content: `He preparado tu lista con ${this.pendingItems.length} productos. ¬øDeseas confirmar y agregarlos a tu lista de compras?`,
                                    timestamp: new Date().toISOString(),
                                    hasPendingItems: true
                                });
                            } else {
                                throw new Error('No es lista de productos');
                            }
                        } catch (e) {
                            // Es una respuesta conversacional normal
                            this.conversation.push({
                                role: 'assistant',
                                content: text,
                                timestamp: new Date().toISOString()
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.conversation.push({
                        role: 'assistant',
                        content: 'Lo siento, tuve un problema al procesar tu mensaje. ¬øPodr√≠as intentarlo de nuevo?',
                        timestamp: new Date().toISOString()
                    });
                } finally {
                    this.loading = false;
                    localStorage.setItem('conversation', JSON.stringify(this.conversation));
                    this.updateUI();
                    this.scrollToBottom();
                }
            }

            confirmItems() {
                if (this.pendingItems) {
                    this.items = [...this.items, ...this.pendingItems];
                    this.saveData();
                    
                    this.conversation.push({
                        role: 'assistant',
                        content: `¬°Perfecto! He agregado ${this.pendingItems.length} productos a tu lista. ¬øNecesitas algo m√°s?`,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.pendingItems = null;
                    localStorage.setItem('conversation', JSON.stringify(this.conversation));
                    this.updateUI();
                    this.scrollToBottom();
                }
            }

            cancelItems() {
                this.conversation.push({
                    role: 'assistant',
                    content: 'De acuerdo, no he agregado nada. ¬øQuieres que modifique algo o prefieres empezar de nuevo?',
                    timestamp: new Date().toISOString()
                });
                
                this.pendingItems = null;
                localStorage.setItem('conversation', JSON.stringify(this.conversation));
                this.updateUI();
                this.scrollToBottom();
            }

            clearChat() {
                if (confirm('¬øSeguro que quieres borrar toda la conversaci√≥n?')) {
                    this.conversation = [];
                    this.pendingItems = null;
                    localStorage.removeItem('conversation');
                    this.updateUI();
                }
            }

            togglePurchased(id) {
                this.items = this.items.map(item =>
                    item.id === id ? { ...item, purchased: !item.purchased } : item
                );
                this.saveData();
                this.updateUI();
            }

            deleteItem(id) {
                this.items = this.items.filter(item => item.id !== id);
                this.saveData();
                this.updateUI();
            }

            clearCompleted() {
                const completed = this.items.filter(i => i.purchased);
                if (completed.length > 0) {
                    this.history.unshift({
                        id: Date.now(),
                        date: new Date().toISOString(),
                        items: completed,
                        total: completed.reduce((sum, i) => sum + (i.estimatedPrice || 0), 0),
                        itemCount: completed.length
                    });
                    this.history = this.history.slice(0, 50);
                    localStorage.setItem('purchase-history', JSON.stringify(this.history));
                }
                this.items = this.items.filter(i => !i.purchased);
                this.saveData();
                this.updateUI();
            }

            saveData() {
                localStorage.setItem('shopping-items', JSON.stringify(this.items));
            }

            scrollToBottom() {
                setTimeout(() => {
                    const chat = document.getElementById('chatMessages');
                    if (chat) chat.scrollTop = chat.scrollHeight;
                }, 100);
            }

            updateUI() {
                const pending = this.items.filter(i => !i.purchased);
                const completed = this.items.filter(i => i.purchased);
                const total = this.items.reduce((sum, i) => sum + (i.estimatedPrice || 0), 0);

                const chatHTML = this.conversation.map((msg, idx) => {
                    if (msg.role === 'user') {
                        return `
                            <div class="flex justify-end mb-4 animate-slideIn">
                                <div class="bg-blue-500 text-white rounded-2xl rounded-tr-sm px-4 py-3 max-w-xs sm:max-w-md">
                                    <p class="text-sm sm:text-base">${msg.content}</p>
                                    <p class="text-xs opacity-70 mt-1">${new Date(msg.timestamp).toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit'})}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="flex justify-start mb-4 animate-slideIn">
                                <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 max-w-xs sm:max-w-md shadow-md">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-xs">ü§ñ</div>
                                        <span class="font-semibold text-sm text-gray-700">Asistente</span>
                                    </div>
                                    <p class="text-sm sm:text-base text-gray-800 whitespace-pre-line">${msg.content}</p>
                                    ${msg.hasPendingItems ? `
                                        <div class="mt-3 flex gap-2">
                                            <button onclick="app.confirmItems()" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-medium">
                                                ‚úì Confirmar
                                            </button>
                                            <button onclick="app.cancelItems()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 text-sm font-medium">
                                                ‚úó Cancelar
                                            </button>
                                        </div>
                                    ` : ''}
                                    <p class="text-xs text-gray-400 mt-2">${new Date(msg.timestamp).toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit'})}</p>
                                </div>
                            </div>
                        `;
                    }
                }).join('');

                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex flex-col">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 shadow-lg">
                            <div class="max-w-4xl mx-auto flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="text-3xl">üõí</div>
                                    <div>
                                        <h1 class="text-xl sm:text-2xl font-bold">Asistente de Compras</h1>
                                        <p class="text-xs sm:text-sm opacity-90">Conversa naturalmente conmigo</p>
                                    </div>
                                </div>
                                <button onclick="app.showList = !app.showList; app.updateUI()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm font-medium">
                                    ${this.showList ? 'üí¨ Chat' : 'üìã Lista'}
                                </button>
                            </div>
                        </div>

                        ${this.showList ? `
                            <!-- Lista de Compras -->
                            <div class="flex-1 overflow-y-auto p-4">
                                <div class="max-w-2xl mx-auto space-y-4">
                                    <!-- Stats -->
                                    <div class="grid grid-cols-3 gap-3">
                                        <div class="bg-white p-3 rounded-xl shadow-md text-center">
                                            <div class="text-2xl font-bold text-blue-600">${pending.length}</div>
                                            <div class="text-xs text-gray-600">Pendientes</div>
                                        </div>
                                        <div class="bg-white p-3 rounded-xl shadow-md text-center">
                                            <div class="text-2xl font-bold text-green-600">${completed.length}</div>
                                            <div class="text-xs text-gray-600">Comprados</div>
                                        </div>
                                        <div class="bg-white p-3 rounded-xl shadow-md text-center">
                                            <div class="text-2xl font-bold text-purple-600">$${total.toFixed(0)}</div>
                                            <div class="text-xs text-gray-600">Total</div>
                                        </div>
                                    </div>

                                    ${pending.length > 0 ? `
                                        <div class="bg-white rounded-2xl shadow-xl p-4">
                                            <h2 class="text-lg font-bold text-gray-800 mb-3">üìã Por Comprar</h2>
                                            <div class="space-y-2">
                                                ${pending.map(item => `
                                                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                                        <button onclick="app.togglePurchased(${item.id})" class="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-green-500 flex-shrink-0"></button>
                                                        <div class="flex-1 min-w-0">
                                                            <div class="font-semibold text-gray-800 truncate">${item.name}</div>
                                                            <div class="text-xs text-gray-500 flex gap-2">
                                                                <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded">${item.quantity}</span>
                                                                <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded">${item.category}</span>
                                                                ${item.estimatedPrice > 0 ? `<span class="text-green-600 font-semibold">$${item.estimatedPrice}</span>` : ''}
                                                            </div>
                                                        </div>
                                                        <button onclick="app.deleteItem(${item.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">üóëÔ∏è</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${completed.length > 0 ? `
                                        <div class="bg-white rounded-2xl shadow-xl p-4">
                                            <div class="flex justify-between items-center mb-3">
                                                <h2 class="text-lg font-bold text-gray-800">‚úÖ Comprados</h2>
                                                <button onclick="app.clearCompleted()" class="px-3 py-1 bg-green-500 text-white rounded-lg text-sm">Finalizar</button>
                                            </div>
                                            <div class="space-y-2">
                                                ${completed.map(item => `
                                                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg opacity-70">
                                                        <button onclick="app.togglePurchased(${item.id})" class="w-6 h-6 rounded-full bg-green-500 flex-shrink-0 flex items-center justify-center">
                                                            <span class="text-white text-sm">‚úì</span>
                                                        </button>
                                                        <div class="flex-1 min-w-0">
                                                            <div class="font-semibold text-gray-800 line-through truncate">${item.name}</div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${this.items.length === 0 ? `
                                        <div class="bg-white rounded-2xl shadow-xl p-12 text-center">
                                            <div class="text-6xl mb-4">üõí</div>
                                            <h3 class="text-2xl font-bold text-gray-700 mb-2">Lista vac√≠a</h3>
                                            <p class="text-gray-500">Habla conmigo para crear tu lista</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : `
                            <!-- Chat -->
                            <div class="flex-1 overflow-y-auto p-4 chat-scroll" id="chatMessages">
                                <div class="max-w-4xl mx-auto">
                                    ${this.conversation.length === 0 ? `
                                        <div class="text-center py-12">
                                            <div class="text-6xl mb-4">üí¨</div>
                                            <h3 class="text-2xl font-bold text-gray-700 mb-2">¬°Hola! Soy tu asistente</h3>
                                            <p class="text-gray-500 mb-4">Puedes decirme cosas como:</p>
                                            <div class="space-y-2 text-sm text-gray-600 max-w-md mx-auto">
                                                <p class="bg-white p-3 rounded-lg shadow">"Necesito 2 kilos de papa, 3 panes y leche"</p>
                                                <p class="bg-white p-3 rounded-lg shadow">"¬øQu√© me falta para hacer un asado?"</p>
                                                <p class="bg-white p-3 rounded-lg shadow">"Agrega frutas y verduras"</p>
                                            </div>
                                        </div>
                                    ` : chatHTML}
                                    
                                    ${this.loading ? `
                                        <div class="flex justify-start mb-4">
                                            <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-md">
                                                <div class="flex items-center gap-2">
                                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `}

                        <!-- Input Area -->
                        <div class="bg-white border-t border-gray-200 p-4 shadow-lg">
                            <div class="max-w-4xl mx-auto">
                                ${!this.showList && this.conversation.length > 0 ? `
                                    <button onclick="app.clearChat()" class="text-xs text-red-600 hover:text-red-700 mb-2">üóëÔ∏è Borrar conversaci√≥n</button>
                                ` : ''}
                                ${this.isListening ? `
                                    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-3 mb-3 text-center animate-pulse">
                                        <p class="text-red-700 font-semibold flex items-center justify-center gap-2">
                                            <span class="inline-block w-3 h-3 bg-red-500 rounded-full animate-ping"></span>
                                            üé§ Escuchando...
                                        </p>
                                    </div>
                                ` : ''}
                                <div class="flex gap-2">
                                    ${this.voiceSupported ? `
                                        <button onclick="app.${this.isListening ? 'stopVoice' : 'startVoice'}()" class="px-4 py-3 rounded-xl font-medium shadow-lg flex items-center gap-2 ${this.isListening ? 'bg-red-500 hover:bg-red-600 animate-pulse' : 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600'} text-white">
                                            <span class="text-xl">üé§</span>
                                        </button>
                                    ` : ''}
                                    <input 
                                        type="text" 
                                        id="chatInput" 
                                        placeholder="Escribe o habla tu lista..." 
                                        class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                    <button onclick="app.sendMessage()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 font-medium shadow-lg">
                                        Enviar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Event listener para Enter
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendMessage();
                    });
                    if (!this.loading) chatInput.focus();
                }
            }

            render() {
                this.updateUI();
            }
        }

        const app = new ShoppingAssistant();
    </script>
</body>
</html>
